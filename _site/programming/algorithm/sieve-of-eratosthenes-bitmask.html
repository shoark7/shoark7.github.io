<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>에라토스테네스의 체 Bitmask로 구현하기 - Parkito's on the way</title>

  <!-- Edit site and author settings in `_config.yml` to make the social details your own -->

    <meta content="Parkito's on the way" property="og:site_name">
  
    <meta content="에라토스테네스의 체 Bitmask로 구현하기" property="og:title">
  
  
    <meta content="article" property="og:type">
  
  
    <meta content="We can implement sieve of Eratosthenes in bitmask version" property="og:description">
  
  
    <meta content="https://shoark7.github.io/programming/algorithm/sieve-of-eratosthenes-bitmask.html" property="og:url">
	
  
    <meta content="2018-12-07T00:00:00+09:00" property="article:published_time">
    <meta content="https://shoark7.github.io/about/" property="article:author">
  
  
    <meta content="https://shoark7.github.io/assets/img/algorithm/sieve-logo.png" property="og:image">
  
  
    
    <meta content="Programming" property="article:section">
    
  
  
    
    <meta content="Algorithm" property="article:tag">
    
    <meta content="Sieve_of_Eratosthenes" property="article:tag">
    
  

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@">
    <meta name="twitter:creator" content="@">
  
    <meta name="twitter:title" content="에라토스테네스의 체 Bitmask로 구현하기">
  
  
    <meta name="twitter:url" content="https://shoark7.github.io/programming/algorithm/sieve-of-eratosthenes-bitmask.html">
  
  
    <meta name="twitter:description" content="We can implement sieve of Eratosthenes in bitmask version">
  
  
    <meta name="twitter:image:src" content="https://shoark7.github.io/assets/img//algorithm/sieve-logo.png">
  

  
    <meta content="We can implement sieve of Eratosthenes in bitmask version" name="description">
  
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<link rel="shortcut icon" href="/assets/img/favicon/favicon.ico" type="image/x-icon">
	<link rel="apple-touch-icon" href="/assets/img/favicon/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicon/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicon/apple-touch-icon-144x144.png">
	<!-- Chrome, Firefox OS and Opera -->
	<meta name="theme-color" content="#263959">
	<!-- Windows Phone -->
	<meta name="msapplication-navbutton-color" content="#263959">
	<!-- iOS Safari -->
	<meta name="apple-mobile-web-app-status-bar-style" content="#263959">
	<!-- Google Fonts -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
	<link href="https://fonts.googleapis.com/css?family=PT+Serif:400,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
	
	<!-- Font Awesome -->
	<link rel="stylesheet" href="/assets/fonts/font-awesome/css/font-awesome.min.css">
	<!-- Styles -->
	<!-- Mathjax Support -->
<script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
	MathJax.Hub.Config({
  showProcessingMessages: false,
  jax: ["input/TeX", "output/HTML-CSS"],
  TeX: {
    TagSide: "left",
    Macros: {
      RR: '{\\bf R}',
      bold: ['{\\bf #1}',1]
    }
  },
  CommonHTML: {
    linebreaks: {automatic: true}
  }
});
</script>

	<link rel="stylesheet" href="/assets/css/main.css">
	<link rel="stylesheet" href="/assets/css/personal.css">
	<link href="https://fonts.googleapis.com/css?family=Do+Hyeon|Nanum+Gothic:400,700,800&amp;subset=korean" rel="stylesheet">
</head>

<body style="position: relative">
	<div id="toggler-wrapper">
		<div id="menu-toggler">
			<img src="/assets/img/nav-off.png" alt="Menu collapse image">
		</div>
	</div>

  <div class="wrapper">

		<nav id="nav">
			<div id="menus">
				<p>
					<a class="navbar-brand text-white" href="/">&nbsp;&nbsp;&nbsp;Parkito's on the way!&nbsp;&nbsp;&nbsp;</a>
				</p>
				<ul id="category-list">
					<li>
						<a href="/about.me">
							<div class="menu">
								<span> About </span>
							</div>
						</a>
					</li>
				
					<li>
						<div class="menu-wrapper">
							<a href="/category/programming">
								<div class="menu">
									<span> Programming </span>
								</div>
							</a>
							<div class="menu-item">
								<a href="/category/programming/knowledge">Knowledge</a>
								<a href="/category/programming/algorithm">Algorithm</a>
								<a href="/category/programming/python">Python</a>
								<a href="/category/programming/shell-programming">Shell programming</a>
							</div>
						</div>
					</li>
				
					<li>
						<div class="menu-wrapper">
								<a href="/category/insight">
									<div class="menu">
										<span> Insight </span>
									</div>
								</a>
								<div class="menu-item">
									<a href="/category/insight/sensitivity">&nbsp;&nbsp;Sensitivity&nbsp;&nbsp;</a>
									<a href="/category/insight/rationality">&nbsp;&nbsp;Rationality&nbsp;&nbsp;</a>
								</div>
						</div>
					</li>

					<li>
						<div class="menu-wrapper">
								<a href="/category/projects">
									<div class="menu">
										<span> Projects </span>
									</div>
								</a>
							<div class="menu-item">
								<a href="/category/projects/dev-related">&nbsp;&nbsp;Dev related&nbsp;&nbsp;</a>
								<a href="/category/projects/etc">&nbsp;&nbsp;ETC&nbsp;&nbsp;</a>
							</div>
						</div> </li>

				</ul>
			</div>

			<div id="menus-right">
				<div id="search-section">
					<div class="input-wrapper">
						<span class="fa fa-search"></span>
						<input type="text" id="search-input" placeholder="Please input specific keyword :)" size="30">
					</div>
					<div id="results-container"></div>
				</div>

				<!--<div id="toggler-wrapper">-->
					<!--<div id="menu-toggler">-->
						<!--<img src="/assets/img/nav-off.png" alt="" width="35px" height="35px">-->
					<!--</div>-->
				<!--</div>-->
				
			</div>
			
		</nav>


    <aside class="sidebar">
  <header>
    <div class="about">
      <div class="cover-author-image">
        <a href="/"><img src="/assets/img/1536558558520.jpg" alt="Sunghwan Park"></a>
      </div>
      <div class="author-name">Sunghwan Park</div>
      <p>I'm Parkito. A Python lover. Interested in Python, Automation, Algorithm. Please give me insights. I'll teach you tambien! :)</p>
    </div>
  </header> <!-- End Header -->
  <footer>
    <section class="contact">
      <h3 class="contact-title">Contact me</h3>
      <ul>
				<!--
        
          <li><a href="https://twitter.com/artemsheludko_" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
        
        
          <li><a href="https://facebook.com/" target="_blank"><i class="fa fa-facebook" aria-hidden="true"></i></a></li>
        
				-->
        
          <li class="github"><a href="http://github.com/shoark7" target="_blank"><i class="fa fa-github"></i></a></li>
        
        
          <li class="linkedin"><a href="https://in.linkedin.com/in/sunghwan-park-3773b8154" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        
        
          <li class="email"><a href="mailto:shoark7@gmail.com"><i class="fa fa-envelope-o"></i></a></li>
        
      </ul>
    </section> <!-- End Section Contact -->
    <div class="copyright">
      <p>2018 &copy; Sunghwan Park</p>
    </div>
  </footer> <!-- End Footer -->
</aside> <!-- End Sidebar -->

<div class="content-box clearfix">
  <article class="article-page">
  <div class="page-content">
    
    <div class="page-cover-image">
      <figure>
        <img class="page-image" src=/assets/img//algorithm/sieve-logo.png alt="에라토스테네스의 체 Bitmask로 구현하기">
        
      </figure>
    </div> <!-- End Page Cover Image -->
    
    <div class="wrap-content">
      <header class="header-page">
        <h1 class="page-title">에라토스테네스의 체 Bitmask로 구현하기</h1>
        <div class="page-date"><span>2018, Dec 07&nbsp;&nbsp;&nbsp;&nbsp;</span></div>
      </header>
      <h2 id="0-들어가며">0. 들어가며</h2>

<hr />

<p>에라토스테네스의 체는 정해진 범위 내의 자연수에서 소수를 걸러내는 데 유용하게 사용되는 알고리즘이다. 이를 개발한 에라토스테네스는 기원전 200여년 전 사람인데 참 대단하다는 생각이 든다. 소수론은 워낙 중요한 분야라 소수를 판별하는 것과 관련된 수많은 알고리즘이 있지만, 수학자가 아닌 평범한 개발자 정도라면 에라토스테네스의 체(이하 “체”) 알고리즘 정도는 1부터 <script type="math/tex">\sqrt{n}</script>까지 나눠보는 간단한 소수 판별법과 함께 모두 알 것이라 생각한다. 나도 체는 한참 전에 만들어본 기억이 있다.</p>

<p>최근 어렴풋이 알고 있던 비트 알고리즘을 좀더 깊이 공부했는데 <strong>공부하는 책에서 비트마스킹을 활용해 체의 공간 효율을 상당 부분 개선할 수 있는 방법을 알고 충격을 받았다.</strong></p>

<p>그래서 이번 포스트에서는</p>
<ol>
  <li><strong>비트마스크를 활용한 체를 구현하고</strong></li>
  <li><strong>비트 연산자가 활용된 코드는 비교적 가독성이 떨어지기 때문에 사용자 인터페이스를 고려해 제품화해보자.</strong></li>
</ol>

<p>이 포스트의 핵심 알고리즘은 <a href="http://www.yes24.co.kr/24/goods/8006522" target="_blank">“종만북”</a>의 16장 ‘비트마스크’장에 크게 빚지고 있다.
제정신 아닌 코드를 소개해준 것에 진심으로 감사드린다.</p>

<p>에라토스테네스의 체와 기본적인 비트마스크 정도의 개념은 이해하고 있을 것이라 가정하고 진행한다.</p>

<h2 id="1-기본적인-구현">1. 기본적인 구현</h2>

<hr />

<p>먼저 비트마스크는 사용하지 않은 일반적인 체를 구현해보자. 당연히 파이썬을 사용하며 원하는 SIZE에 맞게 체를 선언하고 2부터 SIZE까지 소수 판별 작업을 한다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SIZE</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">16</span>
<span class="n">SIZE_SQRT</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">SIZE</span>  <span class="o">**</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
<span class="n">sieve</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">SIZE</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
<span class="n">sieve</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sieve</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">TEST</span> <span class="o">=</span> <span class="mi">20</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">SIZE_SQRT</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">sieve</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="n">SIZE</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
            <span class="n">sieve</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">TEST</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">"{i:&gt;3} : {'prime' if sieve[i] else 'composite'}"</span><span class="p">)</span>
</code></pre></div></div>

<p>평범한 코드다. 체의 크기는 2의 16승으로 잡고(이는 임의의 값을 줬다) 1로 초기화한다. 2부터 <em>for</em> 문을 돌며 값이 1로 되어 있으면 그 수의 배수는 모두 0으로 처리한다. 전혀 어려울 것이 없는데 <strong>배수를 처리하는 <em>j</em> 의 시작값을 <em>i*i</em> 로 한 것만 유의하면 된다.</strong> 가령 3의 배수를 지울 때, 6 같은 경우는 2의 배수로 이미 지워져 있을 것이기 때문에 다시 지울 필요가 없고, 3의 제곱인 9부터 지워나가면 된다.</p>

<p>참고로 2부터 20까지 테스트하는 테스트 코드에서 <strong>‘composite’는 ‘합성수’라는 뜻이다.</strong> 모든 자연수는 1과 소수, 합성수로 이루어지는데 <strong>합성수는 약수가 3개 이상인 수라고 생각하면 될 듯하다.</strong> 이번에 공부하면서 ‘composite’라는 단어를 처음 배워서 짚고 넘어간다.</p>

<h2 id="2-핵심-아이디어">2. 핵심 아이디어</h2>

<hr />

<h3 id="21-에라토스테네스의-체의-장단점">2.1. 에라토스테네스의 체의 장단점</h3>

<p>다른 소수 판별 알고리즘과 비교해서, 체 알고리즘의 장단점은 뭐가 있을까?</p>

<p>일단 <strong>장점은 구현하는 방법이 매우 쉽다는 것이다.</strong> 소수를 판별하는 수많은 연구가 있었고, 효율적인 알고리즘이 많지만 상당수는 나같은 일반인이 이해하기 너무 어려운 것들이 많다. 하지만 체는 최소한의 수학 지식만 있으면 쉽게 구현할 수 있다. <strong>또 다른 장점은 일정 범위 내의 소수를 모두 계산할 수 있다는 것이다.</strong> 이는 일정 범위 내의 자연수에서 소수 판별을 빈번하게 해야 한다면 상당한 캐시 효율을 낼 수 있다는 의미이기도 하다.</p>

<p>하지만 <strong>결정적인 단점으로 간단히 몇 개의 계산만 하려고 해도 1부터 원하는 수까지의 모든 수를 계산해야 하고, 그래서 만약 판별하려는 수가 크다면 공간을 많이 잡아 먹는다.</strong> 가령 1부터 2의 32승까지 체를 계산한다고 할 때, 기본적인 구현은 비트맵으로 자연수 <em>n</em> 이 소수인지 아닌지를 체의 <em>n</em> 인덱스에 1, 0으로 저장한다. 때문에 체를 4바이트 정수 배열로 구현해도 약 4GB의 메모리가 필요하다고 한다. 이 단점으로 인해 우리는 체의 공간 비효율을 어떻게 더 개선할 수 있을까 하는 질문을 던졌고, 그 후보로 <strong>체를 비트마스크를 동원해 구현하는 방법이 제안되었다.</strong></p>

<hr />

<h3 id="22-공간-비효율을-개선하자-비트마스크를-통해">2.2. 공간 비효율을 개선하자: 비트마스크를 통해</h3>

<p>앞선 절에서 체의 단점은 판별하려는 수가 클 때 공간이 많이 낭비되는 것이라고 살펴봤다. 앞선 기본적인 구현은 비트맵으로, 배열의 원소 하나가 해당 원소의 인덱스의 소수 여부를 1과 0으로 담고 있다. 이를 어떻게 개선할 수 있을까?</p>

<p>공간이 문제라면, 원소 하나에 숫자 하나의 소수 여부만 담는 작금의 방식을 개선하면 되지 않을까? 그러니까, <strong>배열의 원소 하나에 여러 숫자의 소수 여부를 담으면 확실히 배열의 크기를 줄일 수 있을 것 같다.</strong></p>

<p><br /></p>

<p>내가 만드려는 체의 크기를 <em>SIZE</em> 라고 하자. 그리고 한 원소는 4바이트 정수를 쓴다고 하자.</p>

<p>그리고 내가 판별하려는 소수가 7이기 때문에 체의 크기가 7이라고 하자. 배열의 크기는 8 * 4, 즉 32 바이트가 될 것이다. 왜 7이 아닌 8를 곱했냐고 하면 당연하다. 크기를 7로 잡으면 배열의 마지막 인덱스가 6이니까 7을 판별할 수 없다. 다 아시겠지만 무시하는 것이 아니고 그냥 적었다. ㅋㅋ</p>

<p>이때, 우리가 하려는 공간 절약은 비트마스크를 통해 실현된다. <strong>기본적인 구현에서 한 원소는 0과 1의 값만 갖는데 이는 한 원소에 1개의 비트만 할당된다고 말할 수 있다.</strong> 1개의 비트를 통해 하나의 수의 소수 여부를 담을 수 있다.</p>

<p><strong>그렇다면 만약 한 원소에 8개의 비트를 담는다면 그 비트들을 통해 8개의 수의 소수 여부를 담을 수 있지 않을까?</strong></p>

<p><img src="/assets/img/algorithm/sieve-bitmask.png" alt="8 bit binary number" /></p>

<p>위 그림은 어떤 8비트 이진수다. 이 수를 표현하기 위해 8개의 비트가 사용되었다. <strong>각 비트는 0부터 7까지의 인덱스를 갖는데, 아까 예에서 한 원소에 1비트만 담는 대신, 한 원소에 8비트 수를 담으면 각 비트의 0, 1 상태를 통해 0부터 7까지 8개의 자연수의 소수 여부를 알 수 있다.</strong> <em>SIZE</em> 가 7일 때, 체의 단 하나뿐인 원소에는 다음과 같은 값이 실릴 것이다.</p>

<script type="math/tex; mode=display">10101100_{2}</script>

<p>이 8비트 이진수는 오른쪽에서부터 0부터 7까지의 소수 판별 여부를 담고 있으며 2, 3, 5, 7은 소수이기 때문에 비트가 켜져 있는 것을 알 수 있다.</p>

<p><strong>배열의 한 원소에 비트를 한 개만 쓰는 일반적인 구현 대신, 한 원소에 비트를 8개씩 쓰는 비트마스크 기법을 통해, 필요한 배열의 크기는 <em>SIZE / 8</em> 로 절약될 수 있다.</strong> <em>SIZE</em> 가 7일 때, 배열의 크기가 1이 된 것을 통해 알 수 있다.</p>

<p><br /></p>

<p>이를 알고리즘으로 구현하자.</p>

<h2 id="3-구현">3. 구현</h2>

<hr />

<p><strong>이 알고리즘의 핵심 아이디어는 기본적인 구현이 체의 한 원소에 0과 1, 즉 1비트만 담음으로써 단 한 개의 자연수의 소수 여부만 담을 수 있던 것과 달리 비트마스크 구현은 한 원소에 8비트씩을 담음으로써 8개의 자연수의 소수 여부를 파악할 수 있고 따라서 필요한 배열(체)의 크기를 8분의 1로 줄일 수 있다는 것이다.</strong></p>

<p>그건 그렇다치고, 이제 이것을 어떻게 실현하는가가 문제이다. 해결해야 하는 주된 문제는 이것이다.</p>

<p><em>체가 판별하려는 최대 숫자가 SIZE 이고 내가 현재 판별하고자 하는 숫자가 n일 때</em></p>
<ol>
  <li><strong>현재 체의 크기는 <em>SIZE / 8</em> 일텐데, 내가 원하는 <em>n</em> 은 체의 몇 번째 원소에 들어 있는가?</strong></li>
  <li><strong>해당하는 원소를 찾았을 때 원소 안의 8비트 수의 어느 비트가 내가 원하는 <em>n</em> 의 소수 여부를 담고 있는가?</strong></li>
</ol>

<p>이 두 문제를 해결하면 동시에 해결하면(AND) 우리가 원하는 수의 소수 여부를 찾을 수 있다.</p>

<p><br /></p>

<p>먼저 1번. 원하는 수는 체의 어느 원소에 들어있을지. 일반적인 구현에서는 단순히 <em>sieve[n]</em> 을 통해 그 여부를 알 수 있었는데 지금은 단순히 <em>n</em> 을 넣어서는 안 된다.  <strong>여기서는 <em>sieve[n &gt;&gt; 3]</em> 를 통해 원소 위치를 찾을 수 있다. 사실 ‘n &gt;&gt; 3’은 기능상 ‘n // 8’과 일치한다.</strong></p>

<p>2번. 체의 원소를 찾았을 때 8비트에서 내가 원하는 원소는 어느 비트에 위치할지. 이는 ‘1 &lt;&lt; (7 &amp; n)’으로 찾을 수 있다. ‘7 &amp; n’을 통해 <em>n</em> 의 7과의 접점을 찾는다. 그러니까 둘의 ‘&amp;’ 연산은 0부터 7까지의 값을 내놓을 것이고, 이는 사실상 ‘<em>n</em> % 8’과 같다. 그 나머지를 ‘(1 &lt;&lt; ‘ 연산으로 원소의 8비트 이진수에서 원하는 비트에 접근할 수 있다.</p>

<p><strong>이 1번과 2번의 교집합을 찾으면 수많은 수에서 우리가 원하는 바로 그 수의 소수 여부를 판단할 수 있다. 코드를 살펴보자.</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 1.
</span><span class="n">SIZE</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1"># Size is too big... Isn't it?
</span>
<span class="c1"># 2.
</span><span class="n">sieve</span> <span class="o">=</span> <span class="p">[</span><span class="mi">255</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">SIZE</span> <span class="o">//</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>

<span class="c1"># 3.
</span><span class="k">def</span> <span class="nf">set_composite</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">sieve</span><span class="p">[</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">))</span>

<span class="c1"># 4.
</span><span class="n">set_composite</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">set_composite</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># 5.
</span><span class="k">def</span> <span class="nf">is_prime</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">sieve</span><span class="p">[</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">))</span> <span class="k">else</span> <span class="bp">False</span>

<span class="c1"># 6.
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">SIZE</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">is_prime</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="n">SIZE</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
            <span class="n">set_composite</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
</code></pre></div></div>

<p>각 부분을 살펴보자.</p>

<ol>
  <li>먼저 체의 크기 <em>SIZE</em> 는 2의 16승이다. 대단한 의미는 없다.</li>
  <li>체의 크기를 ‘<em>SIZE // 8</em>’ 로 잡는다. <strong>그리고 각 원소를 255로 초기화한다. 255는 8개의 비트를 모두 1로 켠 수</strong>이며 기본적인 구현에서 각 원소를 1로 초기화한 것과 일맥상통하다.</li>
  <li>원하는 수 <em>n</em> 합성수로 설정하는 <em>set_composite</em> 함수를 만들었다. 이 함수는 먼저 <em>n</em> 이 속한 체의 원소를 찾고(‘sieve[n &gt;&gt; 3]’), 그 수에서 <em>n</em> 이 속한 비트를 0으로 설정한다.(‘&amp;= ~(1 &lt;&lt; (n &amp; 7)’). 이 코드는 몇 가지 예를 만들어 실험해보라.</li>
  <li>그리고 0과 1은 소수가 아니기 때문에 합성수로 설정한다. 엄밀히 말해 0, 1 모두 합성수는 아니지만 이 예제에서는 소수가 아닌 것만 확인하면 된다.</li>
  <li><em>n</em> 이 소수인지 판단하는 <em>is_prime</em> 함수를 만든다. 이는 앞서 살펴 본 1번과 2번의 교집합(‘&amp;’)을 살핀다. 교집합 비트가 0이면 소수가 아니고, 0이 아니면 소수다.</li>
  <li>2부터 각 수에 대해 체 작업을 한다. 이는 기본적인 구현의 알고리즘과 본질적으로 같다.</li>
</ol>

<p>한 번 테스트해보라.</p>

<hr />

<h2 id="4-제품화">4. 제품화</h2>

<hr />

<h3 id="41-제품화의-필요성">4.1. 제품화의 필요성</h3>

<p><strong>난 위의 비트마스크 체 코드를 제품화할 필요가 있다고 강력하게 느끼고 있다.</strong> 그 이유는 크게 두 가지가 있다.</p>

<p><strong>먼저 비트마스크는 인간에게 직관적이지 않은 2진수 비트를 다루기 때문에 위 코드를 실제 체의 사용자들에게 공개하는 것은 바람직하지 않다.</strong></p>

<p><strong>또한 체를 구현할 때는 어떤 수 <em>n</em> 이 소수인지를 일회성으로 판단하는 경우보다는, 체를 만들어놓고 일정 범위 안에서 빈번히 재활용하려는 경우가 많다.</strong> 많이 사용하는 프로그램은 사용하기 편해야 한다.</p>

<p><br /></p>

<p>이런 이유로 난 위의 체 코드를 클래스를 통해 구현하는 것이 적절하다고 생각했다. <strong>구체적인 코드는 감추고 추상화된 체에 필수적인 인터페이스만 제공하면 사용자는 어려운 비트마스크 따위는 걱정할 필요 없이 행복하게 체를 쓸 수 있을테니까.</strong></p>

<p>내가 제안하는 코드는 다음과 같다.</p>

<hr />

<h3 id="42-클래스로-구현한-비트마스트-체">4.2. 클래스로 구현한 비트마스트 체</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SIZE</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1"># Size is too big... Isn't it?
</span>

<span class="k">class</span> <span class="nc">Sieve</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sieve</span> <span class="o">=</span> <span class="p">[</span><span class="mi">255</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_composite</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_composite</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_prime</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_set_composite</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">"Sieve of size {size} is initialized"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_prime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s">"This sieve only support integers equal to or less than {self._size}"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sieve</span><span class="p">[</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">))</span> <span class="k">else</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_set_composite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sieve</span><span class="p">[</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">))</span>


<span class="n">sieve</span> <span class="o">=</span> <span class="n">Sieve</span><span class="p">(</span><span class="n">SIZE</span><span class="p">)</span>
</code></pre></div></div>

<p>위 코드의 핵심 알고리즘은 앞선 코드와 똑같다. 다만 <strong>구체적인 코드를 캡슐화해 핵심적인 API만 남겼는데 체에서는 ‘<em>is_prime</em>’ 이 된다.(체를 만드는 이유가 그거니까.)</strong></p>

<p>눈여겨 볼 점은 <strong>필수적인 API를 제외한 <em>Sieve</em> 클래스의 ‘<em>size</em>’, ‘<em>sieve</em>’, ‘<em>set_composite</em>’ 특성 앞에 ‘_‘를 붙임으로써 이 특성들은 보호 속성이며 사용자가 건드리지 않는 것이 바람직하다고 암시하고 있다는 것이다.</strong>  확실히 체나 합성수를 설정하는 함수를 사용자가 만져서 좋을 것은 별로 없어보인다. 이를 ‘_‘를 두 개 쓰는 ‘private’이 아닌 ‘protected’ 속성으로 한 것은 이유가 있다. 향후 확장성의 여지가 있다고 생각했기 때문이다. 지금은 인스턴스를 생성할 때 설정한 체의 크기를 수정할 수 없다. 하지만 이 클래스를 상속해 체의 크기를 늘리는 등의 재밌는 활동이 가능하다고 생각했다. 그 여지를 남겨두기 위해 사용자의 개입 여지를 남겼다.</p>

<hr />

<h3 id="43-customization을-조금만-더">4.3. Customization을 조금만 더…</h3>

<p>저 정도 코드도 사실 훌륭하다. 근데 사실 저 알고리즘을 책에서 처음 접했을 때 느낀 생각은 <strong>‘일반적인 정수 배열을 쓰면 한 원소에 4바이트가 할당될테고 그러면 32비트 숫자까지 담을 수 있는데 왜 8비트까지만 담지?’였다.</strong> 8비트가 아니라 16비트를 담으면 체의 크기를 16분의 1로 줄일 수 있을텐데? 반대로 한 원소에 4비트만 담고 싶을 수도 있잖아? 사용자의 필요과 수요는 우리의 상상을 언제나 초월하기 마련이다.</p>

<p>이왕 많은 사용자를 고려한 제품화를 시작한 이상 <strong>체의 원소에 담기는 비트의 수를 조절할 수 있는 인자를 추가하자.</strong> 조절되는 비트 수는 2, 4, 8, 16처럼 2의 제곱수들을 대상으로 하기 때문에 이 숫자들의 지수(1, 2, 3, 4)를 받으면 될 듯하다. 최종적으로 완성된 비트마스크 체는 다음과 같다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SIZE</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1"># Size is too big... Isn't it?
</span>

<span class="k">class</span> <span class="nc">Sieve</span><span class="p">:</span>
    <span class="s">"""Sieve of Eratosthenes in bitmask version

    It supports bitmasking for implementing the sieve internally
    so you can save space.
    """</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">expo</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="s">"""Initialize the sieve with given size and expo

	:input:
	size: INT | Total size of the sieve. You cannot change it. Think carefully.
	expo: INT | The number of exponentials to use bitmask. Default value is 3.
	            That means one element in the sieve contains 8 bit(2 ^ 3) integers.

        :return:
	None. You can now use the sieve with 'is_prime' method. 
	"""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expo</span><span class="o">=</span><span class="n">expo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sieve</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expo</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="n">SIZE</span> <span class="o">&gt;&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expo</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_composite</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_composite</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_prime</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_set_composite</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">"Sieve of size {size} is initialized"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_prime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="s">"""Check if the given n is prime or not

	If n is over than the size of the sieve, raise value error.
	"""</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s">"This sieve only support integers equal to or less than {self._size}"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sieve</span><span class="p">[</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expo</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expo</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span> <span class="k">else</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_set_composite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="s">"""Set the given n composite number in the sieve"""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sieve</span><span class="p">[</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expo</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expo</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>


<span class="n">sieve</span> <span class="o">=</span> <span class="n">Sieve</span><span class="p">(</span><span class="n">SIZE</span><span class="p">)</span>
</code></pre></div></div>

<p>좀더 개선된 <strong>이 체 클래스는 초기화 시 한 원소에 담길 비트 수의 2의 지수를 지정하는 <em>expo</em> 변수를 받는다.</strong> 체의 한 원소에 2의 <em>expo</em> 승만큼의 비트가 담길 예정이며 기본값은 3으로 했다. 특별한 의미는 없고 처음 만들었을 때 8개 비트를 저장해서 그렇게 했다.</p>

<p><strong>그 변수를 이용해 코드의 매직넘버들을 모두 갈아야 한다.</strong> 가령 처음 만든 체 클래스에서 사용된 7, 255, 3 등은 모두 2의 3승인 8과 관련이 있는 매직넘버들이었다. 이때는 체의 한 원소에 담길 비트를 무조건 8비트로 지정했지만 이제는 사용자가 지정할 수 있으므로(Customization!) 모두 그에 맞게 바꾼다.</p>

<p>위와 같이 바꿔서 코드는 사실 더 어려워졌다. 하지만 그게 중요한가? <strong>대부분의 사용자는 실제 코드에 접근하지 않을 것이고 대신 사용자는 자신의 의도에 맞게 체의 크기를 줄이고 늘일 수 있다.</strong> 이 얼마나 행복한가?</p>

<p><br /></p>

<p><strong>마지막으로 훌륭한 프로그램의 기본인 문서화도 잊지 않는다.</strong></p>

<hr />

<h2 id="5-마치며">5. 마치며</h2>

<hr />

<p>이번 포스트에서는 일반적인 에라토스테네스의 체 알고리즘에서 비트마스크를 통해 공간 효율을 개선했다. 그 알고리즘도 알고리즘이지만 클래스를 통해 추상화하고 인터페이스만 남겼다는 개념이 이 포스트의 의의인 것 같다. 우리는 언제나 사용자를 고려해야 한다. 종만북의 알고리즘을 그대로 복붙하지 않고, 이를 활용해 내 포스트를 만들었다는 자부심이 개인적으로 생긴다. 이렇게 지식은 발전한다.</p>

<p>이상 포스트를 마칩니다.</p>


      <div class="page-footer">
        <div class="page-share">
          <a href="https://twitter.com/intent/tweet?text=에라토스테네스의 체 Bitmask로 구현하기&url=https://shoark7.github.io/programming/algorithm/sieve-of-eratosthenes-bitmask.html" title="Share on Twitter" rel="nofollow" target="_blank">Twitter</a>
          <a href="https://facebook.com/sharer.php?u=https://shoark7.github.io/programming/algorithm/sieve-of-eratosthenes-bitmask.html" title="Share on Facebook" rel="nofollow" target="_blank">Facebook</a>
          <a href="https://plus.google.com/share?url=https://shoark7.github.io/programming/algorithm/sieve-of-eratosthenes-bitmask.html" title="Share on Google+" rel="nofollow" target="_blank">Google+</a>
        </div>
        <div class="page-tag">
          
            <a href="/tags#Algorithm" class="tag">&#35; Algorithm</a>
          
            <a href="/tags#Sieve_of_Eratosthenes" class="tag">&#35; Sieve_of_Eratosthenes</a>
          
        </div>
      </div>
		  <!-- Load Facebook SDK for JavaScript -->
  <div id="fb-root"></div>
  <script>(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));</script>

  <!-- Your share button code -->
  <div class="fb-share-button" 
    data-href="https://shoark7.github.io/programming/algorithm/sieve-of-eratosthenes-bitmask.html" 
    data-layout="button_count">
  </div>

		
    </div> <!-- End Wrap Content -->
  </div> <!-- End Page Content -->
</article> <!-- End Article Page -->

</div>

  </div>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', '', 'auto');
  ga('send', 'pageview');
</script> <!-- End Analytics -->

	<script src="https://unpkg.com/simple-jekyll-search@1.5.0/dest/simple-jekyll-search.min.js"></script>
<script>
var sjs = SimpleJekyllSearch({
  searchInput: document.querySelector('#search-input'),
  resultsContainer: document.getElementById('results-container'),
  json: '/search.json',
  searchResultTemplate: '<li class="search-results-item"><a href="https://shoark7.github.io{url}">{title}</a></li>',
	limit: 9,
	noResultsText: '<li class="search-results-item"><a href="#">No results found...</a></li>'
})
</script>

	<!-- Main Js -->
<!--<script src="/assets/js/main.js"></script>-->

<!-- JQuery 3.x min -->
<script src="/assets/js/jquery.js"></script>

<script>
	let menus = $("#category-list");
	let image = $("#menu-toggler img");
	$("#toggler-wrapper").click(function() {
		if(menus.css("display") === "none") {
			image.attr("src", "/assets/img/close-button.png");
			menus.css("display", "flex");
		}
		else {
			image.attr("src", "/assets/img/nav-off.png");
			menus.css("display", "none");
		}
	});


</script>

	<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-127149179-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-127149179-1');
</script>

</body>
</html>
